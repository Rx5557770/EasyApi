{% extends "view/base.html" %}
{% load env %}
{% block content %}
<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- ç”¨æˆ·æ¬¢è¿å¡ç‰‡ -->
        <div class="bg-gradient-to-r from-[#7927F5] to-[#9c60f8] rounded-2xl shadow-lg p-8 text-white mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">æ¬¢è¿å›æ¥ï¼Œ{{ user.username }}ï¼</h1>
            <p class="text-white/80 text-lg">ç®¡ç†æ‚¨çš„ API å‡­è¯å’Œè®¢å•</p>
            <!-- ç§¯åˆ†æ˜¾ç¤º -->
            <div class="mt-6 bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/20">
                <div class="flex items-center justify-between">
                    <span class="text-white/80">Point</span>
                    <span class="text-4xl font-bold">{{ user.user_info.points }}</span>
                </div>
            </div>
        </div>

        <!-- ä¿¡æ¯å¡ç‰‡å®¹å™¨ -->
        <div class="space-y-8">
            <!-- Token ä¿¡æ¯å¡ç‰‡ -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 hover:shadow-md transition-shadow">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"/>
                    </svg>
                    API Token
                </h2>
                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between gap-4 flex-wrap">
                        <code id="token-text" class="font-mono text-sm sm:text-base text-gray-800 break-all flex-1 min-w-0">
                            {{ user.user_info.token }}
                        </code>
                        <button id="copy-btn" class="flex-shrink-0 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors flex items-center whitespace-nowrap">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            å¤åˆ¶
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-500">ğŸ” è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ Tokenï¼Œé¿å…æ³„éœ²ï¼Œå®ƒè¢«ç”¨äºè®¤è¯æ‚¨çš„ API è¯·æ±‚</p>
            </div>

            <!-- API è°ƒç”¨åœ°å€å¡ç‰‡ -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 hover:shadow-md transition-shadow">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM15.657 14.243a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM11 17a1 1 0 102 0v-1a1 1 0 10-2 0v1zM5.757 15.657a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM3 10a1 1 0 011-1h1a1 1 0 110 2H4a1 1 0 01-1-1zM5.757 5.757a1 1 0 000-1.414L5.05 3.636a1 1 0 10-1.414 1.414l.707.707z"/>
                    </svg>
                    æ¥å£è°ƒç”¨åœ°å€
                </h2>
                <div class="bg-gray-900 rounded-xl p-4 mb-4 overflow-x-auto">
                    <code class="text-gray-300 text-sm break-all">
                        {% get_env "API_HOST" %}/apis/<span class="text-yellow-300 font-semibold">æ¥å£ID</span>?token=<span class="text-cyan-300">{{ user.user_info.token }}</span>
                    </code>
                </div>
                <p class="text-sm text-gray-500">å°† <span class="font-mono bg-gray-100 px-2 py-1 rounded text-blue-600">æ¥å£ID</span> æ›¿æ¢ä¸ºå…·ä½“æ¥å£IDå³å¯è°ƒç”¨</p>
            </div>

            <!-- Token ç®¡ç†å¡ç‰‡ -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 hover:shadow-md transition-shadow">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
                    </svg>
                    é‡æ–°ç”Ÿæˆ Token
                </h2>
                <p class="text-gray-600 mb-6">ç”Ÿæˆæ–°çš„ Token åï¼Œæ—§çš„ Token å°†ç«‹å³å¤±æ•ˆã€‚è¯·è°¨æ…æ“ä½œæ­¤æ“ä½œã€‚</p>
                <form method="post" action="{% url 'auth:change_token' %}">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('ç¡®å®šè¦ç”Ÿæˆæ–°çš„ Token å—ï¼Ÿæ—§çš„ Token å°†ç«‹å³å¤±æ•ˆï¼')"
                            class="w-full sm:w-auto bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-semibold py-3 px-8 rounded-lg transition-all duration-200 transform hover:shadow-lg active:scale-95 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        ç”Ÿæˆæ–° Token
                    </button>
                </form>
            </div>

            <!-- è®¢å•åˆ—è¡¨å¡ç‰‡ -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 hover:shadow-md transition-shadow">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM5 16a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    æˆ‘çš„è®¢å•
                </h2>

                {% if not order_list %}
                <div class="py-12 text-center">
                    <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4l1-12z"/>
                    </svg>
                    <p class="text-gray-500 text-lg">æš‚æ— è®¢å•è®°å½•</p>
                    <p class="text-gray-400 text-sm mt-2">å¿«å»è´­ä¹°å¥—é¤å§</p>
                    <a href="{% url 'plan' %}" class="inline-block mt-4 px-6 py-2 bg-[#7927F5] text-white rounded-lg font-medium hover:bg-[#611fc9] transition-colors">
                        æŸ¥çœ‹å¥—é¤
                    </a>
                </div>
                {% else %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b-2 border-gray-200 text-gray-700">
                                <th class="text-left py-3 px-4 font-semibold">è®¢å•ç¼–å·</th>
                                <th class="text-left py-3 px-4 font-semibold hidden sm:table-cell">å¥—é¤</th>
                                <th class="text-left py-3 px-4 font-semibold hidden md:table-cell">æ”¯ä»˜æ–¹å¼</th>
                                <th class="text-left py-3 px-4 font-semibold">é‡‘é¢</th>
                                <th class="text-left py-3 px-4 font-semibold">çŠ¶æ€</th>
                                <th class="text-left py-3 px-4 font-semibold hidden lg:table-cell">æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for order in order_list %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="py-4 px-4 font-mono text-gray-700">{{ order.order_sn }}</td>
                                <td class="py-4 px-4 hidden sm:table-cell text-gray-700">{{ order.plan.name|default:"æœªçŸ¥å¥—é¤" }}</td>
                                <td class="py-4 px-4 hidden md:table-cell text-gray-700">{{ order.get_pay_type_display }}</td>
                                <td class="py-4 px-4 text-red-500 font-semibold">Â¥{{ order.total_amount }}</td>
                                <td class="py-4 px-4">
                                    {% if order.state %}
                                    <span class="inline-block px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold">âœ“ å·²æ”¯ä»˜</span>
                                    {% else %}
                                    <span class="inline-block px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-semibold">â³ å¾…æ”¯ä»˜</span>
                                    {% endif %}
                                </td>
                                <td class="py-4 px-4 text-gray-500 hidden lg:table-cell">{{ order.create_date|date:"m-d H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// å¤åˆ¶Tokenåˆ°å‰ªè´´æ¿
function copyToken() {
    const token = '{{ user.user_info.token }}';
    const copyBtn = document.getElementById('copy-btn');
    const originalText = copyBtn.innerHTML;

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(token).then(() => {
            copyBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>å·²å¤åˆ¶';
            copyBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');

            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                copyBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }, 2000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            fallbackCopyText(token);
        });
    } else {
        fallbackCopyText(token);
    }
}

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        const copyBtn = document.getElementById('copy-btn');
        
        if (successful) {
            copyBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>å·²å¤åˆ¶';
            copyBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            
            setTimeout(() => {
                copyBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>å¤åˆ¶';
                copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                copyBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }, 2000);
        }
    } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    } finally {
        document.body.removeChild(textArea);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const copyBtn = document.getElementById('copy-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', copyToken);
    }
});
</script>
{% endblock %}