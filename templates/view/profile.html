{% extends "view/base.html" %}
{% load env %}
{% block content %}
<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <!-- 用户信息卡片 -->
        <div class="bg-white shadow-lg rounded-2xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <p class="text-sm text-gray-500 mt-2">您当前的点数为:<span class="text-red-500">{{ user.user_info.points }}</span></p>
            </div>

            <!-- Token信息 -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    API Token
                </h2>
                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <code id="token-text" class="font-mono text-gray-800 text-sm sm:text-base break-all">{{ user.user_info.token }}</code>
                        <button id="copy-btn" class="ml-3 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors flex items-center text-sm whitespace-nowrap">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            复制Token
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-2">请妥善保管您的Token，避免泄露</p>
            </div>

            <!-- 接口调用地址 -->
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    接口调用地址
                </h2>
                <div class="bg-gray-900 rounded-lg p-4">
                    <code class="text-gray-300 text-sm sm:text-base break-all">
                        {% get_env "API_HOST" %}/apis/<span class="text-yellow-300">接口id</span>?token={{ user.user_info.token }}
                    </code>
                </div>
                <p class="text-sm text-gray-500 mt-2">将<span class="font-mono text-blue-600">接口id</span>替换为具体接口ID即可调用</p>
            </div>
        </div>

        <!-- 修改Token表单 -->
        <div class="bg-white shadow-lg rounded-2xl p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                修改Token
            </h2>
            <p class="text-gray-600 mb-4">生成新的Token后，旧的Token将立即失效，请谨慎操作。</p>
            <form method="post" action="{% url 'auth:change_token' %}">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('确定要生成新的Token吗？旧的Token将立即失效！')"
                        class="w-full sm:w-auto bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    生成新Token
                </button>
            </form>
        </div>

        <!-- 新增：我的订单列表模块 -->
        <div class="bg-white shadow-lg rounded-2xl p-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V9.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15.211 6.276a1 1 0 000-1.788l-4.764-2.382a1 1 0 00-.894 0L4.789 4.488a1 1 0 000 1.788l4.764 2.382a1 1 0 00.894 0l4.764-2.382zM4.447 8.342A1 1 0 003 9.236V15a1 1 0 00.553.894l4 2A1 1 0 009 17v-5.764a1 1 0 00-.553-.894l-4-2z"/>
                </svg>
                我的订单列表
            </h2>
            <!-- 无订单时的空状态 -->
            {% if not order_list %}
                <div class="py-12 text-center">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                        <path fill-rule="evenodd" d="M19 10a9 9 0 11-18 0 9 9 0 0118 0zm-2 0a7 7 0 11-14 0 7 7 0 0114 0z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-gray-500">暂无订单记录，快去下单吧～</p>
                </div>
            {% else %}
                <!-- 有订单时的表格布局 -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-gray-600 border-b border-gray-200">
                            <tr>
                                <th class="pb-3 px-2">订单编号</th>
                                <th class="pb-3 px-2">购买套餐</th>
                                <th class="pb-3 px-2">支付方式</th>
                                <th class="pb-3 px-2">支付金额</th>
                                <th class="pb-3 px-2">支付状态</th>
                                <th class="pb-3 px-2">创建时间</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for order in order_list %}
                                <tr class="hover:bg-gray-50">
                                    <!-- 系统订单编号 -->
                                    <td class="py-3 px-2 font-mono text-sm">{{ order.order_sn }}</td>
                                    <!-- 套餐名称（兼容套餐为null的情况） -->
                                    <td class="py-3 px-2">{{ order.plan.name|default:"未知套餐" }}</td>
                                    <!-- 支付方式（显示中文） -->
                                    <td class="py-3 px-2">{{ order.get_pay_type_display }}</td>
                                    <!-- 支付金额（保留两位小数） -->
                                    <td class="py-3 px-2 text-red-500 font-medium">¥{{ order.total_amount }}</td>
                                    <!-- 支付状态（带样式区分） -->
                                    <td class="py-3 px-2">
                                        {% if order.state %}
                                            <span class="inline-block px-2 py-1 bg-green-100 text-green-700 rounded text-xs">已支付</span>
                                        {% else %}
                                            <span class="inline-block px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">未支付</span>
                                        {% endif %}
                                    </td>
                                    <!-- 创建时间（格式化） -->
                                    <td class="py-3 px-2 text-gray-500">
                                        {{ order.create_date|date:"Y-m-d H:i:s" }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// 复制Token到剪贴板
function copyToken() {
    const token = '{{ user.user_info.token }}';
    const copyBtn = document.getElementById('copy-btn');
    const originalText = copyBtn.innerHTML;

    // 使用现代剪贴板API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(token).then(() => {
            // 显示成功反馈
            copyBtn.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>已复制';
            copyBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
            copyBtn.classList.add('bg-green-100', 'text-green-700', 'hover:bg-green-200');

            // 2秒后恢复
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('bg-green-100', 'text-green-700', 'hover:bg-green-200');
                copyBtn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
            }, 2000);
        }).catch(err => {
            console.error('剪贴板API复制失败:', err);
            // 降级方案：使用老式方法
            fallbackCopyText(token);
        });
    } else {
        // 降级方案：使用老式方法
        fallbackCopyText(token);
    }
}

// 降级复制方法
function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;

    // 避免滚动到文本区域
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);

    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        const copyBtn = document.getElementById('copy-btn');
        const originalText = copyBtn.innerHTML;

        if (successful) {
            // 显示成功反馈
            copyBtn.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>已复制';
            copyBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
            copyBtn.classList.add('bg-green-100', 'text-green-700', 'hover:bg-green-200');

            // 2秒后恢复
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('bg-green-100', 'text-green-700', 'hover:bg-green-200');
                copyBtn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
            }, 2000);
        } else {
            // 复制失败
            alert('复制失败，请手动复制：\n' + text);
        }
    } catch (err) {
        console.error('老式复制方法失败:', err);
        alert('复制失败，请手动复制：\n' + text);
    } finally {
        document.body.removeChild(textArea);
    }
}

// 绑定点击事件
document.addEventListener('DOMContentLoaded', function() {
    const copyBtn = document.getElementById('copy-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', copyToken);
    }
});
</script>
{% endblock %}